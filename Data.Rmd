---
title: "Data"
author: "mia"
date: "2025-09-18"
output: html_document
---

```{r setup, message=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(purrr)
library(zoo)
library(stringr)

file_path <- "Dataset/ABS Labour Force Survey.xlsx"
sheet_ids <- 2:11

meta_rows <- c(
  "Unit","Series Type","Data Type","Frequency","Collection Month",
  "Series Start","Series End","No. Obs","Series ID"
)

dfs <- lapply(sheet_ids, function(i) {
  df <- read_excel(file_path, sheet = i, col_names = TRUE)
  firstcol <- names(df)[1]
  df <- df %>%
    filter(!(as.character(.data[[firstcol]]) %in% meta_rows)) %>% 
    filter(!if_all(everything(), ~ is.na(.x)))
  df
})

orig_data <- dfs[[1]]
for (j in 2:length(dfs)) {
  orig_data <- cbind(orig_data, dfs[[j]][, -1, drop = FALSE])
}
```

```{r}
key_col <- names(orig_data)[1]

cols_with_persons <- grep("Persons", names(orig_data), value = TRUE, ignore.case = TRUE)
step1 <- orig_data %>% select(-all_of(cols_with_persons))

cols <- names(step1)

step2 <- tibble(
  OriginalName = cols,
  Tokens = strsplit(str_replace_all(cols, "[;>/]+", ";"), ";")
) %>%
  rowwise() %>% mutate(Tokens = list(trimws(Tokens))) %>% ungroup()

is_sex <- function(x) str_to_title(x) %in% c("Males","Females")
is_marital <- function(x) str_detect(str_to_lower(x), "\\bmarried\\b|\\bnever\\s*married\\b|\\bseparated\\b|\\bdivorced\\b|\\bwidowed\\b")
is_population_base <- function(x) {
  lx <- str_to_lower(x)
  str_detect(lx, "civilian population|population aged .* and over|population(?:\\s|$)")
}
is_agegroup <- function(x) {
  lx <- str_to_lower(x)
  str_detect(lx, "\\byears?\\b") & !is_population_base(x)
}
is_employment <- function(x) {
  patt <- paste(
    "\\bemployed\\b",
    "\\bunemployed\\b",
    "full[- ]?time",
    "part[- ]?time",
    "labou?r\\s+force",
    "not\\s+in\\s+the\\s+labou?r\\s+force",
    "\\bnilf\\b",
    "participation\\s+rate",
    "employment\\s+rate",
    "unemployment\\s+rate",
    "employment\\s*(?:to|-|–)\\s*population\\s*ratio",
    sep = "|"
  )
  str_detect(x, regex(patt, ignore_case = TRUE))
}
first_or_na <- function(v) if (length(v) == 0) NA_character_ else v[1]

step3 <- step2 %>%
  rowwise() %>%
  mutate(
    Sex            = first_or_na(Tokens[map_lgl(Tokens, is_sex)]),
    Marital        = first_or_na(Tokens[map_lgl(Tokens, is_marital)]),
    AgeGroup       = first_or_na(Tokens[map_lgl(Tokens, is_agegroup)]),
    PopulationBase = first_or_na(Tokens[map_lgl(Tokens, is_population_base)]),
    Employment     = first_or_na(Tokens[map_lgl(Tokens, is_employment)])
  ) %>%
  ungroup() %>%
  select(OriginalName, AgeGroup, Sex, Marital, PopulationBase, Employment)

long_data <- step1 %>%
  pivot_longer(-all_of(key_col), names_to = "OriginalName", values_to = "Value")

tagged <- long_data %>%
  left_join(step3, by = "OriginalName") %>%
  mutate(Value = as.numeric(Value)) 

final_wide <- tagged %>%
  group_by(across(all_of(c(key_col, "AgeGroup", "Sex", "Marital", "PopulationBase", "Employment")))) %>%
  summarise(Value = sum(Value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = Employment,
    values_from = Value,
    names_glue = "employment_{Employment}"
  ) %>%
  mutate(across(where(is.numeric), ~ round(.x, 3)))


tidy_data <- final_wide %>%
  separate_rows(PopulationBase, sep = ";\\s*") %>%
   mutate(PopulationBase = ifelse(is.na(PopulationBase) | PopulationBase == "", "population_total", PopulationBase)) %>%
  pivot_wider(
    names_from = PopulationBase,
    values_from = employment_NA,
    names_glue = "{PopulationBase}")
```

The dataset originates from the ABS Labour Force Survey (Excel format). Each sheet contains multiple employment-related series reported monthly, with units expressed in thousands of persons (000). The time span covers February 1978 to July 2025, providing 570 monthly observations.
In the raw file, the 2-10 rows consist of metadata, including `Unit`, `Series Type`, `Data Type`, `Frequency`, `Collection Month`, `Series Start/End`, `Number of Observations`, and `Series ID`. From row 11 on wards, the table records the actual observations: the first column denotes the reference month, while subsequent columns correspond to distinct labour force series, such as `Employed Total (Persons)`, `Employed Total (Males)`, and `Employed Part-time (Females)`. During preprocessing, the metadata rows were excluded.

`Person` is the sum of `Male` and `Female.` If contain `Person`, removed. After preprocessing, the dataset contains only male and female disaggregations, with “Persons” (the combined total of both sexes) excluded to avoid redundancy. The analytical dataset therefore consists of monthly observations across multiple age groups, employment statuses, and marital statuses, with sex (Males and Females) retained as a categorical variable. The outcome variable is Value, representing the number of persons (in thousands).

```{r}
observations = dim(tidy_data)[1]
variables = dim(tidy_data)[2]
categorical = sum(sapply(tidy_data, is.character)) 
uniques <- sapply(tidy_data, function(x) n_distinct(x, na.rm = TRUE))
maxunique <- max(uniques)
maxuniquename <- names(uniques)[which.max(uniques)]
overall_missing_pct <- round((sum(is.na(tidy_data))/(nrow(tidy_data)*ncol(tidy_data)))*100,2)
```

## Data Description
The dataset contains `r observations` observations and `r variables ` variables. This mix of quantitative and qualitative features provides the basis for classification.

The categorical variables vary greatly in distinct values. Some are binary, while others are high-cardinality with up to `r maxunique` unique values (e.g., identifiers such as `r maxuniquename`).

```{r}
tidy_data <- tidy_data %>%
  mutate(
    Date      = as.Date(as.numeric(...1), origin = "1899-12-30"),
    YearMonth = as.yearmon(Date)) %>%
  select(-c("...1","Date"))

keys <- c("YearMonth","AgeGroup","Sex","Marital")

combined <- tidy_data %>%
  group_by(across(keys)) %>%
  summarise(
    across(
      everything(),
      ~ dplyr::first(.x[!is.na(.x)],
                     default = if (is.numeric(.x)) NA_real_
                               else if (is.logical(.x)) NA
                               else NA_character_)),.groups = "drop")

```


```{r}
var_summary <- map_dfr(names(tidy_data), function(col) {
  tibble(
    Variable = col,
    Type = class(tidy_data[[col]])[1],
    UniqueValues = n_distinct(tidy_data[[col]])
  )
})
var_summary
```